<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future-Love Dashboard ‚ú®</title>
    <link rel="icon" type="image/png" href="./images/logo.svg">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/collapsible-cards.css">
    <link rel="stylesheet" href="css/sunset-theme.css">
    <link rel="stylesheet" href="css/notifications.css">
</head>
<body>
    <!-- Floating Hearts Animation -->
    <div class="floating-hearts" id="floating-hearts"></div>
    
    <div class="dashboard-container">
        <a href="index.html" class="back-to-home-btn">‚Ü© Quay l·∫°i Trang ch·ªß</a>
        
        <h1 class="dashboard-greeting">Ch√†o m·ª´ng Em Y√™u ‚ù§Ô∏è </h1>
        <p class="dashboard-slogan">M·ªói ng√†y b√™n em l√† m·ªôt m√≥n qu√†.</p>

        <div class="collapsible-cards-container">

            <!-- Card 1: Th√¥ng Tin Y√™u Th∆∞∆°ng -->
            <div class="collapsible-card love-info expanded">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <span class="card-icon">üíñ</span>
                        <div>
                            <div class="card-title">Th√¥ng Tin Y√™u Th∆∞∆°ng</div>
                            <div class="card-subtitle">H√†nh tr√¨nh v√† k·ª∑ ni·ªám c·ªßa ch√∫ng ta</div>
                        </div>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="card-body">
                    <div class="card-content">
                        <div class="mini-grid">
                            <div class="mini-card love">
                                <h5>H√†nh tr√¨nh c·ªßa ta</h5>
                                <div class="card-big-number" id="love-days">...</div>
                                <p>ng√†y h·∫°nh ph√∫c!</p>
                            </div>
                            <div class="mini-card love">
                                <h5>K·ª∑ ni·ªám ƒë·∫∑c bi·ªát</h5>
                                <p>Ng√†y b·∫Øt ƒë·∫ßu: 01/07/2025<br>
                                L·∫ßn ƒë·∫ßu h·∫πn h√≤: 28/04/2025<br>
                                L·∫ßn ƒë·∫ßu n√≥i "Anh y√™u em": hehe ai nh·ªõ n·ªØa </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: ƒê·∫øm Ng∆∞·ª£c -->
            <div class="collapsible-card countdown">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <span class="card-icon">‚è∞</span>
                        <div>
                            <div class="card-title">ƒê·∫øm Ng∆∞·ª£c Ng√†y ƒê·∫∑c Bi·ªát</div>
                            <div class="card-subtitle">Th·ªùi gian c√≤n l·∫°i ƒë·∫øn s·ª± ki·ªán quan tr·ªçng</div>
                        </div>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="card-body">
                    <div class="card-content">
                        <div id="countdown-content">
                            <div class="countdown-display" id="countdown-timer">
                                <div class="countdown-item">
                                    <span class="countdown-number" id="countdown-days">00</span>
                                    <span class="countdown-label">Ng√†y</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-number" id="countdown-hours">00</span>
                                    <span class="countdown-label">Gi·ªù</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-number" id="countdown-minutes">00</span>
                                    <span class="countdown-label">Ph√∫t</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-number" id="countdown-seconds">00</span>
                                    <span class="countdown-label">Gi√¢y</span>
                                </div>
                            </div>
                            <div id="countdown-event-info" style="text-align: center; margin-top: 20px;">
                                <h3 id="event-title-display" style="color: #ff6b6b; margin-bottom: 10px;">S·ª± ki·ªán ƒë·∫∑c bi·ªát</h3>
                                <p id="event-location-display" style="color: #666; font-size: 1.1em; margin-bottom: 5px;">
                                    <strong>üìç ƒê·ªãa ƒëi·ªÉm:</strong> <span id="event-location-text">Ch∆∞a c√≥ th√¥ng tin</span>
                                </p>
                                <p id="event-datetime-display" style="color: #666; font-size: 1em; margin-bottom: 10px;">
                                    <strong>üìÖ Th·ªùi gian:</strong> <span id="event-datetime-text">Ch∆∞a c√≥ th√¥ng tin</span>
                                </p>
                                <p id="event-description-display" style="color: #888; font-style: italic; font-size: 0.9em;">
                                    <span id="event-description-text">Ch∆∞a c√≥ m√¥ t·∫£</span>
                                </p>
                            </div>
                        </div>
                        <div id="no-event-message" style="text-align: center; color: #999; padding: 40px 20px; display: none;">
                            <h3>‚è∞ Ch∆∞a c√≥ s·ª± ki·ªán ƒë·∫∑c bi·ªát</h3>
                            <p>Anh ch∆∞a t·∫°o s·ª± ki·ªán ƒë·∫øm ng∆∞·ª£c n√†o c·∫£!</p>
                            <small>H√£y nh·∫Øc anh t·∫°o s·ª± ki·ªán ƒë·∫∑c bi·ªát nh√©! üíï</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3: L·ªãch Tr√¨nh -->
            <div class="collapsible-card schedule">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <span class="card-icon">üóìÔ∏è</span>
                        <div>
                            <div class="card-title">L·ªãch Tr√¨nh & K·∫ø Ho·∫°ch</div>
                            <div class="card-subtitle">L·ªãch tu·∫ßn v√† s·ª± ki·ªán s·∫Øp t·ªõi</div>
                        </div>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="card-body">
                    <div class="card-content">
                        <h4>üìÖ L·ªãch tu·∫ßn c·ªßa Em</h4>
                        <div class="preview-content">
                            <div class="event-item">
                                <span class="event-time">T2: 19:00</span>
                                <span class="event-title">N√≥i iu anh ‚ù§Ô∏è</span>
                            </div>
                            <div class="event-item">
                                <span class="event-time">T4: 14:00</span>
                                <span class="event-title">H·∫πn h√≤ v·ªõi Anh ‚ù§Ô∏è</span>
                            </div>
                            <div class="event-item">
                                <span class="event-time">T6: 20:00</span>
                                <span class="event-title">G·ªçi cho anh ƒë·ªÉ n√≥i chuy·ªán ‚ù§Ô∏è</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <a href="schedule.html?from=her" class="card-button">üìÖ Xem Chi Ti·∫øt L·ªãch Tu·∫ßn</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 4: Giao Ti·∫øp -->
            <div class="collapsible-card communication">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <span class="card-icon">üíå</span>
                        <div>
                            <div class="card-title">H·ªôp th∆∞ y√™u th∆∞∆°ng</div>
                            <div class="card-subtitle">H·ªôp th∆∞ v√† k·∫øt n·ªëi v·ªõi Anh</div>
                        </div>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="card-body">
                    <div class="card-content">
                        <h4>üì® H·ªôp Th∆∞ T·ª´ Anh</h4>
                        <div id="mailbox-preview" class="preview-content">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>ƒêang t·∫£i th∆∞...</p>
                            </div>
                        </div>
                        <div class="card-actions">
                            <a href="mailbox.html" class="card-button">üì® Xem T·∫•t C·∫£ Th∆∞</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 5: S·ª©c Kh·ªèe -->
            <div class="collapsible-card health">
                <div class="card-header" onclick="toggleCard(this)">
                    <div class="card-header-left">
                        <span class="card-icon">üçì</span>
                        <div>
                            <div class="card-title">S·ª©c Kh·ªèe & ChƒÉm S√≥c</div>
                            <div class="card-subtitle">L·ªãch "D√¢u" v√† theo d√µi s·ª©c kh·ªèe</div>
                        </div>
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="card-body">
                    <div class="card-content">
                        <h4>üçì L·ªãch "D√¢u" Th√¢n M·∫≠t</h4>
                        <div class="mini-grid">
                            <div class="mini-card health">
                                <h5>Chu k·ª≥ hi·ªán t·∫°i</h5>
                                <p id="period-info">
                                    <span id="next-period-countdown">ƒêang t√≠nh to√°n...</span><br>
                                    <span id="cycle-length">Chu k·ª≥ trung b√¨nh: 28 ng√†y</span><br>
                                    <span id="period-duration">Th·ªùi gian: 5 ng√†y</span>
                                </p>
                            </div>
                            <div class="mini-card health">
                                <h5>L·ªãch mini</h5>
                                <div class="calendar-nav">
                                    <button id="prev-month-btn-dash">&lt;</button>
                                    <span id="month-year-title-dash">Th√°ng 11 2025</span>
                                    <button id="next-month-btn-dash">&gt;</button>
                                </div>
                                <div class="calendar-grid-header">
                                    <div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div><div>CN</div>
                                </div>
                                <div id="calendar-days-grid-dash" class="calendar-grid-body">
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <a href="countdown.html?from=her" class="card-button">üçì Xem L·ªãch Chi Ti·∫øt</a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script src="js/firebase-init.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script src="js/smooth-scroll.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/collapsible-cards.js"></script>
    <script src="js/floating-hearts.js"></script>

    <script>
        // Inline initialization for her-dashboard
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof db === 'undefined') {
                console.error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
                return;
            }

            // ƒê·ª£i realtime sync kh·ªüi t·∫°o
            const waitForRealtimeSync = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.realtimeSync && window.realtimeSync.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            };

            try {
                await waitForRealtimeSync();
                
                // Load her data and his data (for mailbox)
                const herDataRef = db.collection('userInfo').doc('herData');
                const hisDataRef = db.collection('userInfo').doc('hisData');
                const [herDoc, hisDoc] = await Promise.all([herDataRef.get(), hisDataRef.get()]);
                
                const herData = herDoc.exists ? herDoc.data() : {};
                const hisData = hisDoc.exists ? hisDoc.data() : {};

                // Merge countdown event t·ª´ hisData v√†o herData
                if (hisData.countdownEvent) {
                    herData.countdownEvent = hisData.countdownEvent;
                }

                // Run her dashboard functions
                runHerDashboard(herData);
                
                // Initialize mailbox preview
                console.log('üì® Kh·ªüi t·∫°o preview h·ªôp th∆∞...');
                updateMailboxPreview(hisData.notesForHer || []);
                
                // Initialize collapsible cards after data is loaded
                if (typeof initCollapsibleCards === 'function') {
                    initCollapsibleCards();
                }

                // Thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞
                // console.log('üîÑ Thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞...');
                
                // L·∫Øng nghe thay ƒë·ªïi h·ªôp th∆∞ t·ª´ anh
                window.realtimeSync.listenToMailbox((notes) => {
                    // console.log('üì® H·ªôp th∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c');
                    updateMailboxPreview(notes);
                });

                // console.log('‚úÖ ƒê·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞ ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p!');

            } catch (error) {
                console.error("L·ªói khi thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c:", error);
                showError("ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi.");
            }
        });

        // Floating Hearts s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông kh·ªüi t·∫°o b·ªüi floating-hearts.js

        // H√†m c·∫≠p nh·∫≠t preview h·ªôp th∆∞
        function updateMailboxPreview(notes) {
            const mailboxPreview = document.getElementById('mailbox-preview');
            if (!mailboxPreview) return;

            if (!notes || notes.length === 0) {
                mailboxPreview.innerHTML = `
                    <div class="empty-mailbox-preview">
                        <div class="empty-icon">üì≠</div>
                        <p>Ch∆∞a c√≥ th∆∞ n√†o t·ª´ anh...</p>
                    </div>
                `;
                return;
            }

            // Hi·ªÉn th·ªã th∆∞ m·ªõi nh·∫•t
            const latestNote = notes[0];
            const date = new Date(latestNote.timestamp);
            const timeString = date.toLocaleDateString('vi-VN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            mailboxPreview.innerHTML = `
                <div class="latest-mail-preview">
                    <div class="mail-preview-header">
                        <span class="sender"> üíå T·ª´: Anh</span>
                        <span class="time">${timeString}</span>
                    </div>
                    <div class="mail-preview-content">
                        ${latestNote.message.length > 80 ? 
                            latestNote.message.substring(0, 80) + '...' : 
                            latestNote.message}
                    </div>
                    <div class="mail-count">
                        ${notes.length > 1 ? `+${notes.length - 1} th∆∞ kh√°c` : ''}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>