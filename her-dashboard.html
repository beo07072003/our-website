<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future-Love Dashboard ‚ú®</title>
    <link rel="icon" type="image/png" href="./images/logo.svg">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard-container">
        <a href="index.html" class="back-to-home-btn">‚Ü© Quay l·∫°i Trang ch·ªß</a>
        
        <h1 class="dashboard-greeting">Ch√†o m·ª´ng Em Y√™u! ‚ú®</h1>
        <p class="dashboard-slogan">M·ªói ng√†y b√™n em l√† m·ªôt m√≥n qu√†.</p>

        <div class="dashboard-grid">

            <div class="dashboard-card card-love-counter">
                <span class="card-icon">üíñ</span>
                <h3>H√†nh tr√¨nh c·ªßa ch√∫ng ta</h3>
                <div id="love-days" class="card-big-number">...</div>
                <p class="card-subtitle">ng√†y h·∫°nh ph√∫c!</p>
                <div class="card-footer">
                    <span>C√πng nhau vi·∫øt ti·∫øp nh√©!</span>
                </div>
            </div>

            <div class="dashboard-card card-countdown">
                <span class="card-icon">‚è∞</span>
                <h3>ƒê·∫øm ng∆∞·ª£c ng√†y ƒë·∫∑c bi·ªát</h3>
                <div id="countdown-timer" class="card-countdown-timer">
                    <span id="countdown-days">00</span> Ng√†y
                    <span id="countdown-hours">00</span> Gi·ªù
                    <span id="countdown-minutes">00</span> Ph√∫t
                    <span id="countdown-seconds">00</span> Gi√¢y
                </div>
                <p class="card-subtitle">ƒë·∫øn ng√†y ch√∫ng ta mong ch·ªù!</p>
                <div class="card-footer">
                    <span>ƒê·ª´ng qu√™n chu·∫©n b·ªã nh√©!</span>
                </div>
            </div>

            <div class="dashboard-card card-weekly-schedule">
                <span class="card-icon">üóìÔ∏è</span>
                <h3>L·ªãch tu·∫ßn c·ªßa Em</h3>
                <div class="weekly-events-list">
                    <div class="event-item">
                        <span class="event-time">T2: 19:00</span>
                        <span class="event-title">Yoga</span>
                    </div>
                    <div class="event-item">
                        <span class="event-time">T4: 14:00</span>
                        <span class="event-title">H·∫πn h√≤ v·ªõi Anh ‚ù§Ô∏è</span>
                    </div>
                    <div class="event-item">
                        <span class="event-time">T6: 20:00</span>
                        <span class="event-title">Xem phim t·∫°i nh√†</span>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="schedule.html?from=her" class="view-all-link">Xem chi ti·∫øt l·ªãch tu·∫ßn &gt;</a>
                </div>
            </div>

            <div class="dashboard-card card-mailbox">
                <span class="card-icon">üíå</span>
                <h3>H·ªôp Th∆∞ T·ª´ Anh</h3>
                <div id="mailbox-preview" class="mailbox-preview">
                    <p>ƒêang t·∫£i th∆∞...</p>
                </div>
                <a href="mailbox.html" class="card-button">üì® Xem T·∫•t C·∫£ Th∆∞</a>
            </div>

            <div class="dashboard-card card-period-calendar full-width-card">
                <span class="card-icon">üçì</span>
                <h3>L·ªãch "D√¢u" Th√¢n m·∫≠t</h3>
                <div class="calendar-nav">
                    <button id="prev-month-btn-dash">&lt;</button>
                    <span id="month-year-title-dash">Th√°ng 11 2025</span>
                    <button id="next-month-btn-dash">&gt;</button>
                </div>
                <div class="calendar-grid-header">
                    <div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div><div>T7</div><div>CN</div>
                </div>
                <div id="calendar-days-grid-dash" class="calendar-grid-body">
                    </div>
                <div class="card-footer">
                    <a href="countdown.html?from=her" class="card-button">Xem L·ªãch Chi Ti·∫øt &gt;</a>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script src="js/firebase-init.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script src="js/smooth-scroll.js"></script>
    <script src="js/dashboard.js"></script>

    <script>
        // Inline initialization for her-dashboard
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof db === 'undefined') {
                console.error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
                return;
            }

            // ƒê·ª£i realtime sync kh·ªüi t·∫°o
            const waitForRealtimeSync = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.realtimeSync && window.realtimeSync.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            };

            try {
                await waitForRealtimeSync();
                
                // Load her data
                const herDataRef = db.collection('userInfo').doc('herData');
                const herDoc = await herDataRef.get();
                const herData = herDoc.exists ? herDoc.data() : {};

                // Run her dashboard functions
                runHerDashboard(herData);

                // Thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞
                console.log('üîÑ Thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞...');
                
                // L·∫Øng nghe thay ƒë·ªïi h·ªôp th∆∞ t·ª´ anh
                window.realtimeSync.listenToMailbox((notes) => {
                    console.log('üì® H·ªôp th∆∞ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c');
                    updateMailboxPreview(notes);
                });

                console.log('‚úÖ ƒê·ªìng b·ªô th·ªùi gian th·ª±c cho h·ªôp th∆∞ ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p!');

            } catch (error) {
                console.error("L·ªói khi thi·∫øt l·∫≠p ƒë·ªìng b·ªô th·ªùi gian th·ª±c:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi.");
            }
        });

        // H√†m c·∫≠p nh·∫≠t preview h·ªôp th∆∞
        function updateMailboxPreview(notes) {
            const mailboxPreview = document.getElementById('mailbox-preview');
            if (!mailboxPreview) return;

            if (!notes || notes.length === 0) {
                mailboxPreview.innerHTML = `
                    <div class="empty-mailbox-preview">
                        <div class="empty-icon">üì≠</div>
                        <p>Ch∆∞a c√≥ th∆∞ n√†o t·ª´ anh...</p>
                    </div>
                `;
                return;
            }

            // Hi·ªÉn th·ªã th∆∞ m·ªõi nh·∫•t
            const latestNote = notes[0];
            const date = new Date(latestNote.timestamp);
            const timeString = date.toLocaleDateString('vi-VN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            mailboxPreview.innerHTML = `
                <div class="latest-mail-preview">
                    <div class="mail-preview-header">
                        <span class="sender">üë®‚Äçüíª T·ª´: Anh</span>
                        <span class="time">${timeString}</span>
                    </div>
                    <div class="mail-preview-content">
                        ${latestNote.message.length > 80 ? 
                            latestNote.message.substring(0, 80) + '...' : 
                            latestNote.message}
                    </div>
                    <div class="mail-count">
                        ${notes.length > 1 ? `+${notes.length - 1} th∆∞ kh√°c` : ''}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>