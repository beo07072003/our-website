<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hộp Thư Của Em 💌</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/mailbox.css">
    <link rel="stylesheet" href="css/sunset-theme.css">
    <link rel="stylesheet" href="css/notifications.css">
    <link rel="icon" type="image/png" href="./images/logo.svg">
</head>
<body>
    <!-- Floating Hearts Animation -->
    <div class="floating-hearts" id="floating-hearts"></div>
    
    <div class="mailbox-container">
        <!-- Stitch decorations -->
        <div class="stitch-decoration"></div>
        <div class="stitch-decoration"></div>
        <div class="stitch-decoration"></div>
        
        <a href="#" id="back-to-dashboard-btn" class="back-to-dashboard-btn">↩ Quay lại</a>
        
        <div class="mailbox-header">
            <h1>💌 Hộp Thư Của Em</h1>
            <p class="mailbox-subtitle">Những lời nhắn yêu thương từ anh 💕</p>
        </div>

        <div id="mailbox-content" class="mailbox-content">
            <div class="loading-message">
                <div class="loading-spinner"></div>
                <p>Đang tải thư...</p>
            </div>
            <div class="scroll-fade-bottom"></div>
        </div>

        <div class="mailbox-footer">
            <button id="refresh-mailbox-btn" class="refresh-btn">
                🔄 Làm mới hộp thư
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/mailbox.js"></script>
    <script src="js/floating-hearts.js"></script>

    <script>
        // Inline initialization for mailbox page
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof db === 'undefined') {
                console.error("Firebase chưa được khởi tạo!");
                return;
            }

            // Đợi realtime sync khởi tạo
            const waitForRealtimeSync = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.realtimeSync && window.realtimeSync.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            };

            try {
                await waitForRealtimeSync();
                
                // Khởi tạo hộp thư
                initializeMailbox();

                // Thiết lập đồng bộ thời gian thực cho hộp thư
                // console.log('🔄 Thiết lập đồng bộ thời gian thực cho hộp thư...');
                
                window.realtimeSync.listenToHisData((hisData) => {
                    // console.log('📨 Hộp thư đã được cập nhật theo thời gian thực');
                    updateMailbox(hisData.notesForHer || []);
                });

                // console.log('✅ Đồng bộ thời gian thực cho hộp thư đã được thiết lập!');

            } catch (error) {
                console.error("Lỗi khi thiết lập đồng bộ thời gian thực:", error);
                showError("Đã xảy ra lỗi khi kết nối.");
            }
        });
    </script>
</body>
</html>
