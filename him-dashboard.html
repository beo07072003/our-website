<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báº£ng Äiá»u Khiá»ƒn Cá»§a Anh</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/him-dashboard.css">
    <link rel="icon" type="image/png" href="./images/logo.svg">
</head>
<body>
    <div class="dashboard-container">
        <a href="index.html" class="back-to-home-btn">â†© Quay láº¡i Trang chá»§</a>
        
        <h1 class="dashboard-greeting">Báº£ng Äiá»u Khiá»ƒn Cá»§a Anh ğŸ‘¨â€ğŸ’»</h1>
        <p class="dashboard-slogan">NÆ¡i nhá»¯ng Ä‘iá»u báº¥t ngá» báº¯t Ä‘áº§u.</p>

        <div class="dashboard-grid">
            <div class="dashboard-card card-note">
                <span class="card-icon">ğŸ’Œ</span>
                <h3>Há»™p ThÆ° Gá»­i Em</h3>
                <textarea id="note-input" placeholder="Viáº¿t má»™t lá»i nháº¯n yÃªu thÆ°Æ¡ng..."></textarea>
                <button id="save-note-btn" class="card-button">Gá»­i vÃ o há»™p thÆ°</button>
            </div>

            <div class="dashboard-card card-ideas">
                <span class="card-icon">ğŸ’¡</span>
                <h3>NgÃ¢n HÃ ng Ã TÆ°á»Ÿng</h3>
                <div id="idea-preview-list" class="idea-preview">
                    <p>ChÆ°a cÃ³ Ã½ tÆ°á»Ÿng nÃ o...</p>
            </div>
            <a href="ideas.html" class="card-button">Quáº£n lÃ½ Ã½ tÆ°á»Ÿng</a>
        </div>

            <div class="dashboard-card card-schedule-manager">
                <span class="card-icon">ğŸ—“ï¸</span>
                <h3>Lá»‹ch Tuáº§n Cá»§a Em</h3>
                <div id="next-event-preview">
                    <p>Äang táº£i lá»‹ch trÃ¬nh...</p>
                </div>
                <a href="schedule.html?from=him" class="card-button">Quáº£n lÃ½ Lá»‹ch Tuáº§n</a>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/realtime-sync.js"></script>
    <script src="js/profile.js"></script>

    <script>
        // Inline initialization for him-dashboard with realtime sync
        window.addEventListener('DOMContentLoaded', async () => {
            if (typeof db === 'undefined') {
                console.error("Firebase chÆ°a Ä‘Æ°á»£c khá»Ÿi táº¡o!");
                return;
            }

            // Äá»£i realtime sync khá»Ÿi táº¡o
            const waitForRealtimeSync = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.realtimeSync && window.realtimeSync.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            };

            try {
                await waitForRealtimeSync();
                
                // Load dá»¯ liá»‡u ban Ä‘áº§u
                const herDataRef = db.collection('userInfo').doc('herData');
                const hisDataRef = db.collection('userInfo').doc('hisData');
                const [herDoc, hisDoc] = await Promise.all([herDataRef.get(), hisDataRef.get()]);
                
                const herData = herDoc.exists ? herDoc.data() : {};
                const hisData = hisDoc.exists ? hisDoc.data() : {};

                // Khá»Ÿi táº¡o dashboard
                runHimPages(herData, hisData);

                // Thiáº¿t láº­p Ä‘á»“ng bá»™ thá»i gian thá»±c
                console.log('ğŸ”„ Thiáº¿t láº­p Ä‘á»“ng bá»™ thá»i gian thá»±c...');
                
                // Láº¯ng nghe thay Ä‘á»•i dá»¯ liá»‡u "em" (lá»‹ch tuáº§n)
                window.realtimeSync.listenToHerData((herData) => {
                    console.log('ğŸ“± Cáº­p nháº­t dá»¯ liá»‡u "em" theo thá»i gian thá»±c');
                    // Cáº­p nháº­t lá»‹ch tuáº§n preview
                    if (typeof setupSchedulePreview === 'function') {
                        setupSchedulePreview(herData.schedule || []);
                    }
                });

                // Láº¯ng nghe thay Ä‘á»•i dá»¯ liá»‡u "anh" (Ã½ tÆ°á»Ÿng, ghi chÃº)
                window.realtimeSync.listenToHisData((hisData) => {
                    console.log('ğŸ‘¨â€ğŸ’» Cáº­p nháº­t dá»¯ liá»‡u "anh" theo thá»i gian thá»±c');
                    // Cáº­p nháº­t Ã½ tÆ°á»Ÿng preview
                    if (typeof setupIdeaWidget === 'function') {
                        setupIdeaWidget(hisData.ideaBank || []);
                    }
                });

                console.log('âœ… Äá»“ng bá»™ thá»i gian thá»±c Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p!');

            } catch (error) {
                console.error("Lá»—i khi thiáº¿t láº­p Ä‘á»“ng bá»™ thá»i gian thá»±c:", error);
                alert("ÄÃ£ xáº£y ra lá»—i khi káº¿t ná»‘i.");
            }
        });
    </script>
</body>
</html>